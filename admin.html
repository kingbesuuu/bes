
import express from 'express';
import http from 'http';
import { Server } from 'socket.io';
import cors from 'cors';
import { join, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';
import { Low } from 'lowdb';
import { JSONFile } from 'lowdb/node';

const __dirname = dirname(fileURLToPath(import.meta.url));
const app = express();
app.use(cors());
app.use(express.json());

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

const PORT = process.env.PORT || 3000;
const dbFile = join(__dirname, 'db.json');
const adapter = new JSONFile(dbFile);
const db = new Low(adapter);

await db.read();
db.data ||= { users: {}, devices: {} };
await db.write();

app.use(express.static(join(__dirname, 'public')));

// Serve SPA fallback if needed
app.get('*', (req, res) => {
  res.sendFile(join(__dirname, 'public', 'admin.html'));
});

const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || 'YourStrongAdminPassword!';

function getAllUsers() {
  return Object.entries(db.data.users).map(([userKey, u]) => ({
    userKey,
    username: u.username,
    balance: u.balance,
    deviceId: u.deviceId
  }));
}

async function emitUserListToAdmins() {
  await db.read();
  adminIo.emit('userList', getAllUsers());
}

const adminIo = io.of('/admin');
adminIo.on('connection', (socket) => {
  console.log('Admin connected:', socket.id);
  emitUserListToAdmins();
});

app.get('/admin/users', async (req, res) => {
  const { adminSecret } = req.query;
  if (adminSecret !== ADMIN_PASSWORD) {
    return res.json({ success: false, error: 'Unauthorized' });
  }
  await db.read();
  return res.json({ success: true, users: getAllUsers() });
});

app.get('/admin/get-balance', async (req, res) => {
  const { userKey, adminSecret } = req.query;
  if (adminSecret !== ADMIN_PASSWORD) {
    return res.json({ success: false, error: 'Unauthorized' });
  }
  await db.read();
  const user = db.data.users[userKey];
  if (!user) return res.json({ success: false, error: 'User not found' });
  return res.json({ success: true, userKey, username: user.username, balance: user.balance });
});

app.post('/admin/update-balance', async (req, res) => {
  const { userKey, balance, adminSecret } = req.body;
  if (adminSecret !== ADMIN_PASSWORD) {
    return res.json({ success: false, error: 'Unauthorized' });
  }
  await db.read();
  if (!db.data.users[userKey]) return res.json({ success: false, error: 'User not found' });

  const newBalance = Number(balance);
  if (isNaN(newBalance) || newBalance < 0) {
    return res.json({ success: false, error: 'Invalid balance value' });
  }

  db.data.users[userKey].balance = newBalance;
  try {
    await db.write();
    await emitUserListToAdmins();
    return res.json({ success: true });
  } catch {
    return res.json({ success: false, error: "Failed to write to database." });
  }
});

app.post('/admin/delete-user', async (req, res) => {
  const { userKey, adminSecret } = req.body;
  if (adminSecret !== ADMIN_PASSWORD) {
    return res.json({ success: false, error: 'Unauthorized' });
  }
  await db.read();
  if (!db.data.users[userKey]) return res.json({ success: false, error: 'User not found' });

  const deviceId = db.data.users[userKey].deviceId;
  if (deviceId && db.data.devices[deviceId] === userKey) {
    delete db.data.devices[deviceId];
  }
  delete db.data.users[userKey];

  try {
    await db.write();
    await emitUserListToAdmins();
    return res.json({ success: true });
  } catch {
    return res.json({ success: false, error: "Failed to write to database." });
  }
});

// You can add your game logic handlers under here...

server.listen(PORT, () => {
  console.log(`âœ… Bingo server running at http://localhost:${PORT}`);
});
